---
layout: default
title: England Athletics Licence Checker
permalink: /licencechecker/
tags: englandathletics licence check
---

	<style>
		dl {
			font-size: 1.2em;
		}
		@media screen and (max-width: 767px) {
			.dl-horizontal dt {
				width: 110px;
				display: inline-block;
			}
			.dl-horizontal dd {
				display: inline-block;
				min-width: 100px;
			}
		}

		.modal-content>div {
			color: #fff;
		}
		.success {
			background-color: #3A3;
		}
		.warning {
			color: #000;
			background-color: #FA0;
		}
		.danger {
			background-color: #A33;
		}
		img {
			max-width: 100%
		}
		.modal-body .glyphicon {
			font-size: 1.3em;
			top: 3px;
		}
		.close {
			font-size: 2em;
		}
	</style>

<div class="container">
<p class="hidden-xs">This page uses England Athletics' new Licence Checker service.  Anyone building an entry system can now validate athletes as they sign up!  </p>

<div class="panel panel-default">
	<div class="panel-heading"><h3 class="panel-title">Athlete data <small class="pull-right visible-xs">EA Licence Check</small></h3></div>
	<div class="panel-body">
		<br>
		<form class="form" role="form">
			<div class="row form-group">
				<label class="col-sm-2" for="id_first_name">First Name</label>
				<div class="col-sm-7">
					<input type="text" class="form-control" id="id_first_name">
				</div>
			</div>
			<div class="row form-group">
				<label class="col-sm-2" for="id_last_name">Last Name</label>
				<div class="col-sm-7">
					<input type="text" class="form-control" id="id_last_name">
				</div>
			</div>
			<div class="row form-group">
				<label class="col-sm-2" for="id_date_of_birth">Date of Birth</label>
				<div class="col-sm-7">
					<input type="date" class="form-control" id="id_date_of_birth" placeholder="yyyy-mm-dd">
				</div>
			</div>
			<div class="row form-group">
				<label class="col-sm-2" for="id_ea_reg_no">EA Reg. No.</label>
				<div class="col-sm-7">
					<input type="text" class="form-control" id="id_ea_reg_no">
					<div id="alert_placeholder"></div>
				</div>
			</div>
			<div class="col-sm-7 col-sm-offset-2">
				<label for="id_nocache">
					<input type="checkbox" name="nocache" id="id_nocache" value="1"> No Cache
				</label>
				<button type="button" class="btn btn-primary pull-right" id="id_check_now">Check</button>
			</div>
		</form>
	</div>
</div>

<p class="visible-xs">This page uses England Athletics' new Licence Checker service.  Anyone building an entry system can now validate athletes as they sign up!  </p>

<p>If you are familiar with SOAP APIs, you can call them directly.  Service details are <a href="https://stagemyathletics.uka.org.uk/LicenceCheckService/LicenceCheck.svc">here</a>.  For documentation and a license key, event organisers and software authors should contact 
<a href="mailto:rwhile@englandathletics.org">Richard While</a> at <a href="http://www.englandathletics.org/">England Athletics</a></p>

<h2>An easier API wrapper?</h2>
<p>As a public service to ease adoption of registration numbers, We tried to make it a bit easier with a "wrapper".  You call our server, we call theirs, but with three improvements</p>
<ul>
  <li>Nickname resolution - e.g. 'Andy' and 'Andrew' will both work.</li>
  <li>ReSTful API - just call a URL, without needing any SOAP libraries.  So you can call it in Javascript in your web forms</li>
  <li>Cacheing - if an athlete comes back registered for the season, we'll remember this, and won't hit EA again.</li>
</ul>

<p>Try some examples by editing URLs in your browser bar (see screenshot)</p>

<img class="img-rounded media" style="border: 1px solid" src="/img/api_url_screenshot.png" alt="Editing URLs">
<br>
<br>

<p>You can click on any of the URLs below, then edit it to change names or URNs.  The data packet which comes back is hopefully readable; "registered=true" tells you they are paid up.</p>

<ul>
  <li>Lookup by a valid URN: <a href="//test-raceresults.reportlab.com/ref/eacheck/proxy/?urn=2772389">?urn=2772389</a></li>
  <li>Lookup by name and date of birth: <a href="//test-raceresults.reportlab.com/ref/eacheck/proxy/?fn=Andy&ln=Robinson&dob=1966-03-21">?fn=Andy&ln=Robinson&dob=1966-03-21</a></li>
  <li>Lookup by a name slightly different to the one EA has stored<a href="//test-raceresults.reportlab.com/ref/eacheck/proxy/?fn=Andrew&ln=Robinson&dob=1966-03-21">?fn=Andrew&ln=Robinson&dob=1966-03-21</a></li>
</li>
</ul>

<br><br><br>

	<div class="modal fade" id="output" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="myModalLabel">EA Licence Check</h4>
		  </div>
		  <div class="modal-body">
			...
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>

	<script src="/js/jquery.js"></script>
	<script>
		function showalert(message,alerttype,delay) {
			if (typeof alerttype !== 'undefined')
			alerttype=' alert-'+alerttype;
			else
				alerttype='alert-warning';
			$('#alert_placeholder').append('<div id="alertdiv" class="alert' +  alerttype + '"><a class="close" aria-hidden="true" type="button"  data-dismiss="alert">Ã—</a><span>'+message.replace("'","\'")+'</span></div>');
			setTimeout(function() { 
			  if ($("#alertdiv").length)
			$("#alertdiv").remove();
			}, delay?delay:5000);
		  };

		var inProgress = false,
			ea_results = {},
			msg = '',
			statusError = false;

		function calcAge(dateString) {
			var birthday = +new Date(dateString);
			return ~~((Date.now() - birthday) / (31557600000));
		}

		var showError = function(obj) {
			var opts = ['info', 'CheckRegistrationStatus_Fn_Ln_DobResult', 'CheckRegistrationStatus_UrnResult'],
				i = 0,
				l = opts.length,
				error = false;
			for (;i<opts.length; i++) {
				if (obj.hasOwnProperty(opts[i])) {
					if (obj[opts[i]].length) {
						showalert(obj[opts[i]], 'danger');
						return 
					}
				}
			}
			showalert('An unknown error occurred', 'danger')
		};

		var eacheck = function(kwargs) {
				var noCache = $('#id_nocache:checked').length;
				if (noCache)
					kwargs.nocache=1;
					
				$.ajax({
					url: 'http://test-raceresults.reportlab.com/ref/eacheck/proxy/',
					data: kwargs,
					crossDomain: true,
					}).done(function(data, status, xhr){
						var hasErrors = false;
						if (data.hasOwnProperty('result')) {
							if (data.result) {
								var res = data.result;
								if (res == "error") {
									showError(data)
								} else {
									if (res.hasOwnProperty('LastName')) {
										var ln = $('#id_last_name').val()
										if (ln.length && ln.toLowerCase() != res.LastName.toLowerCase()) {
											msg += 'The Last Name returned from EA [ ' + res.LastName + ' ] differs from the one you entered [ ' + ln +  ' ]';
											statusError = true;
											hasErrors = true;
										}
									}
									if (res.hasOwnProperty('FirstName')) {
										var fn = $('#id_first_name').val()
										if (fn.length && fn.toLowerCase() != res.FirstName.toLowerCase()) {
											if (hasErrors) {
												msg = 'The name entered [ ' + fn + ' ' + ln + '] differs from the one in EA: ' + res.FirstName + ' ' + res.LastName;
											} else 
												msg += 'The First Name returned from EA [ ' + res.FirstName + ' ] differs from the one you entered [ ' + fn +  ' ]';
											hasErrors = true;
										}
									}
									if (res.hasOwnProperty('Age')) { 
										var val = $('#id_date_of_birth').val(),
											dob = new Date(val),
											fy = dob.getFullYear();
										if (fy>999) {
											var age = calcAge(val);
											if (Math.abs(age - parseInt(res.Age)) > 1) {
												if (hasErrors)
													msg += '<br>';
												msg += 'The Age returned from EA [ ' + res.Age+ ' ] differs from the one you entered [ ' + age +  ' ]';
												statusError = true;
												hasErrors = true;
											}
										}
									}
									ea_results = res;
									$('#output').modal('show');
								}
							} else {
								showError(data)
							}

						}
					}).always(function(){
						// restore button functionality
						window.setTimeout(function() {
							inProgress = false;
							$('#id_check_now').removeAttr('disabled');
						}, 300)
					})
				};

		var checkHandler = function(e) {
				if (inProgress)
					return;
				// prevent onchange excited by clicking on the Check button to trigger 2 consecutive lookups 
				inProgress = true;
				$('#id_check_now').attr('disabled', true);
				var urn = $('#id_ea_reg_no').val();
				if (urn.length) {
					if (urn.length < 7) {
						showalert('Please enter a proper EA Registration Number', 'danger')
					} else {
						eacheck({urn:$('#id_ea_reg_no').val() });
						return true
					}
				} else {
					var fn = $('#id_first_name').val(), 
						ln = $('#id_last_name').val(),
						dob = $('#id_date_of_birth').val();

					if (fn.length && ln.length && dob.length) {
						var dd = new Date(dob),
							fy = dd.getFullYear();
						if (!isNaN(fy)) {
							if (fy>999) {
								if (fy>1900 && fy < new Date().getFullYear()) {
									eacheck({ fn: fn, ln: ln, dob: dob }); 
									return true
								} else {
									showalert('Date of birth is out of range')
								}
							}
						} else {
							showalert('Invalid date of birth')
						}
					} else {
						if (e.target.id == 'id_check_now')
							showalert('Please fill in minimal data', 'danger')
						window.setTimeout(function() {
							inProgress = false;
							$('#id_check_now').removeAttr('disabled');
						}, 300)
					}
				}
				inProgress = false;
				$('#id_check_now').removeAttr('disabled');
			}


		$(document).ready(function(){
			$('form input').change(checkHandler);
			$('#id_check_now').click(checkHandler);
			$('body>#alert_placeholder').remove();
			$('#output').on('show.bs.modal', function(e) {
				var ss = '',
					reg_context = 'danger';
				if (ea_results.hasOwnProperty('Registered')) {
					if (ea_results.Registered == true) {
						reg_context = 'success';
					}
				}
				if (msg.length) {
				ss+= '<div class="alert alert-warning"> <div class="pull-right glyphicon glyphicon-exclamation-sign"> </div> ' + msg + '</div>';
					if (reg_context == 'success' && statusError) {
						reg_context = 'warning'
					}
				}
				statusError = false;
				ss += '<dl class="dl-horizontal">';
				// sort the output entries
				var AA = new Array();
				for (var o in ea_results) {
					AA.push(o)
					}
				AA.sort();
				var heading = "Unknown",
					icon = 'question-sign';
				if (ea_results.hasOwnProperty('Registered')) {
					if (ea_results.Registered) {
						heading = 'Registered';
						icon = 'ok-sign'
					} else {
						heading = 'Unpaid';
						icon = 'remove-sign'
					}
				}
				$(this).find('.close').html('\
					<span aria-hidden="true" class="glyphicon glyphicon-' + icon + '"></span>');
				$(this).find('#myModalLabel').html(heading);



				var o = '', i=0, aal = AA.length;
				for (; i<aal; i++) {
					o = AA[i];
					ss += '<dt>' + o + '</dt><dd>';
					if (ea_results[o] === true)
						ss += 'Yes <span class="glyphicon glyphicon-ok-sign"> </span>';
					else
						if (ea_results[o] === false)
							ss += 'No <span class="glyphicon glyphicon-remove-sign"> </span>';
						else
							ss += ea_results[o];
						ss += '</dd>';
				}
				ss += '</dl>';
				$(this).find('.modal-body').html(ss);
				$(this).find('.modal-content>div').removeClass('danger').removeClass('success').removeClass('warning').addClass(reg_context);
				ea_results = {};
				msg = '';
			})
		});
	</script>
